<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>Chat Room - Home</title>
  </head>
  <body>
    <header>
      <nav>
        <div id="logo">CC</div>
        <ul>
          <li><a id="healthRoom" href="/books">Books</a></li>
          <li>
            <a id="entertainmentRoom" href="/entertainment">Entertainment</a>
          </li>
          <li><a id="technologyRoom" href="/technology">Technology</a></li>
          <li><a id="healthRoom" href="/health">Health</a></li>
        </ul>
      </nav>
    </header>

    <section id="main-section">
      <h1>Welcome to the Conversation Cubbyhole</h1>
      <label for="username">Username: </label>
      <input type="text" id="username" />
      <button id="setUsernameBtn">Set Username</button>
      <div id="usernameError"></div>
    </section>

    <section id="chat">
      <div>
        <button id="techRoomBtn" value="technologyRoom">Join tech room</button>

        <label>Name</label>
        <input id="name" name="a" type="text" /><br />
        <label>Comment</label>
        <input id="comment" name="b" type="text" /><br />
        <input id="imageUploader" type="file" name="image" />
      </div>
      <ul id="messages"></ul>
    </section>

    <script type="module" src="js/local.js"></script>

    <script>
      // set username in localStorage
      // function setNameLocally() {
      //   let username = $("#username").val();
      //   if (username.length == 0) {
      //     // set error message to error
      //     $("#usernameError").text("Please enter a username.");
      //   } else {
      //     // change error text to success
      //     $("#usernameError").text(`Username is set to ${username}`);

      //     console.log("setting name in local storage...");
      //     window.localStorage.setItem("name", $("#username").val());

      //     $.post(
      //       "/jquery/submitData", // url
      //       { name: username }, // data to be submit
      //       function (data, status, xhr) {
      //         // success callback
      //         alert("status: " + status + ", data: " + data.responseData);
      //       },
      //       "json"
      //     );
      //   }
      // }

      // $("#setUsernameBtn").click(setNameLocally);

      // socket code, setting username
      let socket = io();
      // run function when setUsername btn is clicked
      $("#setUsernameBtn").on("click", () => {
        // socket.on("connect", function () {
        let myUsername = $("#username").val();
        // let myUsername = prompt("Enter username: ");
        console.log(myUsername);
        socket.emit("createUser", myUsername);
      });
      // });
    </script>

    <script>
      // let userName;
      // let socket = io();
      let clientSessionID = "";
      let isMessageSentByCurrentUser = false;
      let roomName = "global";

      // join technology room with the button
      $("#techRoomBtn").on("click", () => {
        console.log("JOINING TECH ROOM");
        socket.emit("joinRoom", $("#techRoomBtn").val());
      });

      // set clientSessionID once client is connected
      socket.on("connect", () => {
        clientSessionID = socket.id;
        // join room global
        socket.emit("joinRoom", roomName);
      });

      //Get message from server.
      socket.on("message", function (username, data) {
        console.log("commented " + data);
        // display message
        $("#messages").append(
          `<li> ${username ? username : "Anonymous"}: ${data.comment}</li>`
        );
        // in old code just remember the data passed in has a .name property
      });

      socket.on("connectToRoom", function (data) {
        // log out the client side session ID
        console.log(clientSessionID);
        // send different global messages depending on if the client is seeing it or others are seeing it
        if (data.serverSessionID == clientSessionID) {
          $("#messages").append("<li>You have " + data.message + "</li>");
        } else {
          $("#messages").append(
            `<li>${data.username} has ${data.message}</li>`
          );
        }
      });

      function Clicked() {
        socket.emit("message", {
          name: $("#name").val(),
          comment: $("#comment").val(),
          image: $("#imageUploader"),
          // FIX image path, for now we just have a image property
        });
        return false;
      }

      $(document).ready(function () {
        console.log("ready");
        $("#name").keydown(function (event) {
          if (event.which === 13) {
            Clicked();
            event.preventDefault();
            return false;
          }
        });
        $("#comment").keydown(function (event) {
          if (event.which === 13) {
            Clicked();
            $("#comment").val("");
            event.preventDefault();
            return false;
          }
        });
      });
    </script>
  </body>
</html>
